# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

version: "3"

tasks:
  secrets:
    desc: generate secrets
    silent: true
    cmds:
      - config SECRET_OPENWHISK_SYSTEM="$(random --uuid):$(random --str 64)" SECRET_OPENWHISK_NUVOLARIS="$(random --uuid):$(random --str 64)"
      - config SECRET_COUCHDB_ADMIN="$(random --str 12)" SECRET_COUCHDB_CONTROLLER="$(random --str 12)"  SECRET_COUCHDB_INVOKER="$(random --str 12)"
      - config SECRET_REDIS_DEFAULT="$(random --str 12)" SECRET_REDIS_NUVOLARIS="$(random --str 12)"
      - config SECRET_MONGODB_ADMIN="$(random --str 12)" SECRET_MONGODB_NUVOLARIS="$(random --str 12)"
      - config SECRET_MINIO_ADMIN="$(random --str 40)" SECRET_MINIO_NUVOLARIS="$(random --str 40)"
      - config SECRET_POSTGRES_ADMIN="$(random --str 12)" SECRET_POSTGRES_REPLICA="$(random --str 12)" SECRET_POSTGRES_NUVOLARIS="$(random --str 12)"
      - config SECRET_NUVOLARIS_METADATA="$(random --str 12)"
      - echo "Generated $(config -d | grep SECRET_ | wc -l) secrets."

  user-secrets:
    desc: generate user secrets (auth, couchdb, redis, mongodb, minio, postgres)
    silent: true
    cmds:
      - |
        export USR={{._username_}}
        config "${USR}_SECRET_OPENWHISK"="$(random --uuid):$(random --str 64)"
        config "${USR}_SECRET_COUCHDB"="$(random --str 12)"
        config "${USR}_SECRET_REDIS"="$(random --str 12)"
        config "${USR}_SECRET_MONGODB"="$(random --str 12)"
        config "${USR}_SECRET_MINIO"="$(random --str 40)"
        config "${USR}_SECRET_POSTGRES"="$(random --str 12)"
        echo "Generated ${USR} user secrets."

  nosecrets:
    desc: remove secrets
    ignore_error: true
    cmds:
      - config -r SECRET_OPENWHISK_SYSTEM SECRET_OPENWHISK_NUVOLARIS
      - config -r SECRET_COUCHDB_ADMIN SECRET_COUCHDB_CONTROLLER  SECRET_COUCHDB_INVOKER
      - config -r SECRET_REDIS_DEFAULT SECRET_REDIS_NUVOLARIS
      - config -r SECRET_MONGODB_ADMIN SECRET_MONGODB_NUVOLARIS
      - config -r SECRET_MINIO_ADMIN SECRET_MINIO_NUVOLARIS
      - config -r SECRET_POSTGRES_ADMIN SECRET_POSTGRES_REPLICA SECRET_POSTGRES_NUVOLARIS
      - config -r SECRET_NUVOLARIS_METADATA
      - config -d | grep SECRET_

  no-user-secrets:
    desc: remove user secrets
    silent: true
    ignore_error: true
    cmds:
      - |
        export USR={{._username_}}
        config -r "${USR}_SECRET_OPENWHISK"
        config -r "${USR}_SECRET_COUCHDB"
        config -r "${USR}_SECRET_REDIS"
        config -r "${USR}_SECRET_MONGODB"
        config -r "${USR}_SECRET_MINIO"
        config -r "${USR}_SECRET_POSTGRES"
        echo "Removed ${USR} user secrets."

  poll:
    desc: wsk poll
    cmds:
      - wsk activation poll

  realpath:
    - realpath {{._file_}}

  notify:
    silent: true
    cmds:
      - |
        if test -z "$DO_NOT_NOTIFY_NUVOLARIS" 
        then curl -s -d "Installed '{{._message_}}'" https://ntfy.sh/nuvolaris-nir >/dev/null
        fi
 
  ntfy2slack:
    desc: install a service to receive slack notifications of installation

  1password:
    desc: 1password support utils

  check-operator-version:
    silent: true
    cmds:
      - |
        output=$(nuv debug operator:version)
        tag=$(echo $output | awk -F: '{print $2}')
        needupdate {{._version_}} $tag

  kubectl:
    silent: true
    cmds:
    - |
      # no quote here - syntax array generated by docps
      args={{._args_}} 
      # exanded and assigned to positional parameter
      set -- ${args[@]}
      # removing the '--' at the beginning required to pass extra flags
      test "$1" = "--" && shift
      # execute the command line as passed and expanded
      kubectl "$@"
    env:
      KUBECONFIG:
        sh: |-
          if test -e $NUV_TMP/kubeconfig
          then echo $NUV_TMP/kubeconfig
          else echo ~/.kube/config
          fi

  kubeconfig:
    silent: true
    prompt: are you sure? I am overwriting your ~/.kube/config
    desc: exporting kubeconfig to ~/.kube/config - WARNING IT OWERWRITES IT
    cmds:
      - |
        if test -e "$NUV_TMP/kubeconfig"
        then  
          if test -e ~/.kube/config
          then BKP=~/.kube/config.$(datefmt -f ms)
               mv ~/.kube/config $(realpath $BKP)
               BKP="renamed old to $BKP"
          fi
          cp "$NUV_TMP/kubeconfig" ~/.kube/config
          echo exported current kubeconfig to ~/.kube/config
          echo $BKP
          kubectl cluster-info
        else echo "No kubeconfig to export"
        fi
