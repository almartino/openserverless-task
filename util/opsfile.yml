version: 3

vars:
  OS: "{{or .__OS OS}}"
  ARCH: "{{or .__ARCH ARCH}}"
  ARC: '{{if eq .OS "windows"}}.zip{{else}}.tar.gz{{end}}'
  EXE: '{{if eq .OS "windows"}}.exe{{else}}{{end}}'
  DRY: ""

tasks:

  system:
    desc: system info
    silent: true
    cmds:
    - echo "{{OS}}-{{ARCH}}"


  update-cli:
    desc: update CLI
    silent: true
    vars:
       BASE: "https://github.com/apache/openserverless-cli/releases/download"
       VER:
        sh: jq .version -r $OPS_ROOT/opsroot.json
       URL: "{{.BASE}}/v{{.VER}}/openserverless-cli_{{.VER}}_{{.OS}}_{{.ARCH}}{{.ARC}}"
       FILE: "{{base .URL}}"
    cmds:
    - echo "Trying to update ops..."
    - curl -sL "{{.URL}}" -o "$OPS_TMP/{{.FILE}}"
    - |
      cd "$OPS_TMP"
      extract "{{.FILE}}" "ops{{.EXE}}"
    - |
      if test -z "$OPS_SKIP_UPDATE_CLI"
      then
        if rename "$OPS_TMP/ops{{.EXE}}" "$OPS_CMD"
        then echo "ops updated!"
        else echo "cannot update ops - please execute 'ops util update-cli' as an administrator"
        fi
      else 
        echo "skipping rename $OPS_TMP/ops{{.EXE}} $OPS_CMD"
      fi


  check-operator-version:
    desc: check running operator version and warns it is obsolete (TODO)
    silent: true
    cmds:
    - echo "TODO checking the running operator version"

